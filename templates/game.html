{% extends '_game.html' %}
{% block content %}
    </body>
    <body id = "game-body">
    <br><br>
    <div class = "container">
        <div class = "row">
            <div class = "nav" id = "buildingNav">
                <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
                <a id = "building" ondragstart="move(this.id);">  
                    <img width="100px" src="/s/building.png" border="0">
                </a>           
            </div>

            <div class = "nav" id = "searchNav">
                <a href="javascript:void(0)" class="closebtn" onclick="closeNav2()">&times;</a>
                <a>  
                    <tr>
                        <td id = "inputElement">
                        <label for="uname">Search:</label>
                        </td>
                        <td id = "inputElement">
                        <input type="text" id="uname" name="uname">
                        </td>
                    </tr>
                </a>           
            </div>

            <div class = "nav" id = "listNav">
                <a href="javascript:void(0)" class="closebtn" onclick="closeNav3()">&times;</a>
                <a>  
                    List Here.
                </a>           
            </div>
            <div class = "nav" id = "customNav">
                <a href="javascript:void(0)" class="closebtn" onclick="closeNav4()">&times;</a>
                <a>  
                    <strong>Change Collectible Label</strong>
                    Singular:
                    <input type="text" id="singular" value="">
                    Plural:
                    <input type="text" id="plural" value="">
                    <input type="button" id="updateColLabelButton" value="Update" onclick="updateCollectionLabel()">
                    <div id="updateColLabelError" hidden></div>
                </a>  
            </div>            

            <div class = "column" style='float:left; width:10%'>
                <div class = "box" id = "1" onclick="openNav()">
                    <span style="font-size:20px;cursor:pointer;">Buildings</span>
                </div>
                <div class = "box" id = "2" onclick="openNav2()">
                    <span style="font-size:20px;cursor:pointer;" >Friend Search</span>
                </div>
                <div class = "box" id = "3" onclick="openNav3()">
                    <span style="font-size:20px;cursor:pointer;">Friend List</span>
                </div>
                <div class = "box" id = "4" onclick="openNav4()">
                    <span style="font-size:20px;cursor:pointer;">Customize</span>
                </div>
            </div>

            <div  class = "column" id = "gameArea" style='float:left; width:75%; margin-left:40px'>
                <div id="test" draggable="true" ondragstart="drag(this.id,event);"> </div>                  
                <div id="click-object">
                    <img src="/s/click-object.png" onclick="inc()" alt="click object" height="256em" width="256em">
                </div>
            </div>       
            
            <div  class = "column" style='float:left; width:15%; margin-right:0px'>
            </div>
        </div>
    </div>

    <script>
        
        {% if user is defined %}
            let userObj = cleanAccountJson( {{ user|tojson }} );

            // check if user gained collectibles offline
            if (userObj.left_game > 0) {
                // do calculations
                let elapsedSeconds = Math.floor((Date.now() - userObj.left_game) / 1000);
                console.log("It has been " + elapsedSeconds + " seconds since the last game page visit");
                userObj.collectibles = userObj.collectibles + (elapsedSeconds * userObj.cps);
                console.log("generated " + (elapsedSeconds * userObj.cps) + " collectibles since they were gone! " + elapsedSeconds + " seconds away at a rate of " + userObj.cps + " cps");
                saveAndUpdateLocal();
            }
            else{
                console.log("first time visiting the game page!");
            }

            updateUIOnLoad(userObj.uname);

            // initialize cps incrementing and saving interval
            setInterval(addCPSLocal, 1000);
            setInterval(saveAndUpdateLocal, 10000);

        {% else %}
            let count = 0;
        {% endif %}

        function saveAndUpdateLocal(){
            //updateAccountFromJson(userObj); < deprecated
            // convert the JSON into a string, sendBeacon doesn't take JSON objects
            let userStr = JSON.stringify(userObj);
            // sendBeacon makes a POST request, but tells the browser to make it whenever it can
            // Allows the POST request to be sent even if the page that requested it isn't loaded
            navigator.sendBeacon("/updateAccountFromJson", userStr);
        }

        function addCPSLocal(){
            
            /*
            let total = 0;

            for(let i = 0; i < userObj.factories.length; i++){
                //console.log("i:" + i);
                //console.log("userObj.factories: " + userObj.factories[i]);
                if(userObj.factories[i] > 0){
                    total += getFactories()[i].cps_boost * userObj.factories[i];
                }
            }
            */

            userObj.collectibles += userObj.cps;
            document.getElementById("total").textContent = userObj.collectibles.toLocaleString();
        }        

        function buyFactoryLocal(factoryID){
             
            // if the user can afford the factory
            if (userObj.collectibles >= getFactories()[factoryID].currentPrice(userObj.factories[factoryID])){
                // take the collectibles to pay for it
                userObj.collectibles -= getFactories()[factoryID].currentPrice(userObj.factories[factoryID]);
                // give them the factory
                userObj.factories[factoryID] += 1;
                // update user cps
                userObj.cps = userObj.cps + getFactories()[factoryID].cps_boost;
                // update the UI to reflect the changes
                updateUI(userObj);
            }
        }        

        // Ignore the warnings, flask/jinja replaces above correctly

        function inc(){

            {% if user is defined %}
                
                userObj.collectibles = userObj.collectibles + 1;
                document.getElementById("total").textContent = userObj.collectibles.toLocaleString();

            {% else %}
                // do nothing, doesn't have an account
                count = count + 1;
                document.getElementById("total").textContent = count.toLocaleString();
            {% endif %}

        }

        // updates the datastore entity with data from the the user's session when they leave the page
        document.addEventListener('visibilitychange', function leaveGame(){
            
            //console.log("\nWell leaveGame() is being called at least\n");

            {% if user is defined %}

               // This is the surefire way to detect when the page is left
               // Page passes through the hidden state before the terminated state
               // Can't detect terminated state, but can detect hidden state more reliably than onunload/pagehide
               if(document.visibilityState == "hidden"){
                //userObj['leftGame'] = ;
                    userObj.left_game = Date.now();
                    saveAndUpdateLocal();
                    console.log("saved");
               }

            {% else %}
                // do nothing, doesn't have an account
            {% endif %}
        });

        //drag stuff
        building.onmousedown = function(event) {

            let shiftX = event.clientX - building.getBoundingClientRect().left;
            let shiftY = event.clientY - building.getBoundingClientRect().top;

            building.style.position = 'absolute';
            building.style.zIndex = 1000;
            document.body.append(building);

            moveAt(event.pageX, event.pageY);

            // moves the building object at (pageX, pageY) coordinates
            // taking initial shifts into account
            function moveAt(pageX, pageY) {
                building.style.left = pageX - shiftX + 'px';
                building.style.top = pageY - shiftY + 'px';
            }

            function onMouseMove(event) {
                moveAt(event.pageX, event.pageY);
            }

            // move the building object on mousemove
            document.addEventListener('mousemove', onMouseMove);

            // drop the building object, remove unneeded handlers
            building.onmouseup = function() {
                document.removeEventListener('mousemove', onMouseMove);
                building.onmouseup = null;
            };
            
            building.ondragstart = function() {
                return false;
            };
        };

            //menu stuff (I'm lazy so I just made a function for each menu)
            function openNav() {
            document.getElementById("buildingNav").style.width = "180px";
            }

            function closeNav() {
            document.getElementById("buildingNav").style.width = "0";
            }

            function openNav2() {
            document.getElementById("searchNav").style.width = "250px";
            }

            function closeNav2() {
            document.getElementById("searchNav").style.width = "0";
            }

            function openNav3() {
            document.getElementById("listNav").style.width = "250px";
            }

            function closeNav3() {
            document.getElementById("listNav").style.width = "0";
            }

            // customize menu
            function openNav4() {
                document.getElementById("customNav").style.width = "250px";
            }

            function closeNav4() {
                document.getElementById("customNav").style.width = "0";
                document.getElementById("updateColLabelError").setAttribute("hidden", "true");
            }

            function updateCollectionLabel() {

                let sinOptionContent = document.getElementById("singular").value;
                let plurOptionContent = document.getElementById("plural").value;
                let errMsg = document.getElementById("updateColLabelError");

                {% if user is defined %}
                if ((sinOptionContent.trim() != '' && sinOptionContent.trim().length <= 20) && (plurOptionContent.trim() != '' && plurOptionContent.trim().length <= 25)){
                    userObj.collectible_label_s = sinOptionContent;
                    userObj.collectible_label_p = plurOptionContent;
                    saveAndUpdateLocal();
                    updateUI(userObj);
                    errMsg.innerHTML = "<strong>Updated successfully!</strong>";
                }
                else if (sinOptionContent.trim() == '' && plurOptionContent.trim() != ''){
                    errMsg.innerHTML = "<strong>Singular option is blank!</strong>";
                }
                else if (sinOptionContent.trim() != '' && plurOptionContent.trim() == ''){
                    errMsg.innerHTML = "<strong>Plural option is blank!</strong>";
                }
                else if (sinOptionContent.trim() == '' && plurOptionContent.trim() == ''){
                    errMsg.innerHTML = "<strong>Both options are blank!</strong>";
                }
                else if (sinOptionContent.trim().length > 20){
                    errMsg.innerHTML = "<strong>Singular label must be less than or equal to 20 characters!</strong>";
                }
                else if (plurOptionContent.trim().length > 25){
                    errMsg.innerHTML = "<strong>Plural label must be less than or equal to 25 characters!</strong>";
                }
                {% else %}
                    errMsg.innerHTML = "<strong>Please log in first!</strong>";
                {% endif %}

                errMsg.removeAttribute("hidden");

                //console.log("'" + sinOptionContent + "' | '" + plurOptionContent + "'");
                //console.log(typeof(sinOptionContent) + " | " + typeof(plurOptionContent));
                //console.log(typeof(sinOptionContent.trim()) + " | " + typeof(plurOptionContent.trim()));

            }

    </script>

{% endblock %}
